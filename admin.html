<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Admin | The Modest Company</title>

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600&family=Inter:wght@400;500&display=swap" rel="stylesheet">

<style>
:root{
  --gold:#d4af37;
  --border:#222;
  --muted:#aaa;
}
*{box-sizing:border-box}
body{
  margin:0;background:#000;color:#fff;font-family:Inter,sans-serif
}
header{
  padding:18px 24px;border-bottom:1px solid var(--border)
}
.logo{
  font-family:'Playfair Display',serif;color:var(--gold);font-size:20px
}
.admin-wrap{
  max-width:1100px;margin:40px auto;padding:0 24px
}
.panel{
  border:1px solid var(--border);
  padding:22px;
  margin-bottom:26px;
  background:#050505
}
h2{
  font-family:'Playfair Display',serif;
  color:var(--gold);
  margin:0 0 14px
}
.form-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:14px
}
.full{grid-column:1/-1}
input,textarea,select{
  width:100%;
  padding:12px;
  background:#000;
  color:#fff;
  border:1px solid var(--border)
}
textarea{min-height:90px;resize:vertical}
button{
  padding:12px 18px;
  background:#000;
  color:#fff;
  border:1px solid #444;
  cursor:pointer
}
button:hover{border-color:var(--gold)}
.row{
  display:flex;
  gap:12px;
  align-items:center;
  margin-top:14px;
  flex-wrap:wrap
}
.tag{
  border:1px solid var(--border);
  padding:8px 10px;
  font-size:12px;
  color:var(--muted)
}
.table{
  width:100%;
  border-collapse:collapse;
  margin-top:14px
}
.table th,.table td{
  border-bottom:1px solid var(--border);
  padding:10px;
  font-size:13px;
  text-align:left
}
.table th{color:var(--gold)}
.miniimg{
  width:48px;
  height:60px;
  object-fit:cover;
  border:1px solid var(--border)
}
.danger{
  border-color:#5a1a1a;
  color:#ffb3b3
}
#loginOverlay{
  position:fixed;
  inset:0;
  background:#000;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999
}
@media(max-width:900px){
  .form-grid{grid-template-columns:1fr}
}
</style>
</head>

<body>

<header>
  <div class="logo">The Modest Company — Admin</div>
</header>

<!-- ================= LOGIN OVERLAY ================= -->
<div id="loginOverlay">
  <div class="panel" style="width:360px">
    <h2>Admin Login</h2>
    <input id="adminKeyInput" type="password" placeholder="Enter Admin Key">
    <button style="margin-top:12px;width:100%" onclick="login()">Enter Dashboard</button>
    <div id="loginError" style="color:#ffb3b3;font-size:13px;margin-top:8px"></div>
  </div>
</div>

<!-- ================= DASHBOARD ================= -->
<div class="admin-wrap" id="dashboard" style="display:none">

  <!-- ANALYTICS -->
  <div class="panel">
    <div class="row" style="justify-content:space-between;margin-top:0">
      <h2>Sales Analytics</h2>
      <select id="range" onchange="loadAnalytics()">
        <option value="today">Today</option>
        <option value="week">This Week</option>
        <option value="month">This Month</option>
      </select>
    </div>
    <div class="row">
      <div class="tag">Orders: <b id="statOrders">0</b></div>
      <div class="tag">Revenue: ₹<b id="statRevenue">0</b></div>
      <div class="tag">Top Product: <b id="statTop">—</b></div>
    </div>
  </div>

  <!-- ADD PRODUCT -->
  <div class="panel">
    <h2>Add Product</h2>

    <div class="form-grid">
      <input id="title" placeholder="Product title">
      <input id="price" type="number" placeholder="Price">

      <select id="category">
        <option value="burka">Burka</option>
        <option value="shawl">Shawl</option>
        <option value="accessories">Accessories</option>
      </select>

      <input id="stock" type="number" placeholder="Stock">

      <div class="full">
        <label style="font-size:13px;color:var(--muted)">Images</label>
        <input id="imageUpload" type="file" multiple accept="image/*">
        <div class="row" id="preview"></div>
      </div>

      <div class="full">
        <textarea id="description" placeholder="Description"></textarea>
      </div>
    </div>

    <div class="row">
      <button onclick="addProduct()">Add Product</button>
      <span class="tag" id="status">Ready</span>
    </div>
  </div>

  <!-- PRODUCTS -->
  <div class="panel">
    <h2>All Products</h2>
    <table class="table">
      <thead>
        <tr>
          <th>Image</th>
          <th>Title</th>
          <th>Category</th>
          <th>Price</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="productRows"></tbody>
    </table>
  </div>

</div>

<script>
/* =====================================================
   CONFIG
===================================================== */
const API = "https://themodestcompany.onrender.com";
let uploadedImages = [];

/* =====================================================
   ADMIN KEY HELPERS
===================================================== */
function getKey(){ return sessionStorage.getItem("ADMIN_KEY"); }
function setKey(k){ sessionStorage.setItem("ADMIN_KEY",k); }
function clearKey(){ sessionStorage.removeItem("ADMIN_KEY"); }

/* =====================================================
   LOGIN
===================================================== */
async function login(){
  const key = adminKeyInput.value.trim();
  if(!key) return;

  const res = await fetch(`${API}/api/admin/products`,{
    headers:{ "x-admin-key": key }
  });

  if(!res.ok){
    loginError.innerText = "Invalid admin key";
    return;
  }

  setKey(key);
  loginOverlay.style.display="none";
  dashboard.style.display="block";
  loadAnalytics();
  loadProducts();
}

/* AUTO LOGIN */
if(getKey()){
  loginOverlay.style.display="none";
  dashboard.style.display="block";
  loadAnalytics();
  loadProducts();
}

/* =====================================================
   IMAGE UPLOAD → /api/admin/upload
===================================================== */
imageUpload.addEventListener("change", async ()=>{
  uploadedImages=[];
  preview.innerHTML="";

  const fd=new FormData();
  [...imageUpload.files].forEach(f=>fd.append("images",f));
  fd.append("category",category.value);

  const res=await fetch(`${API}/api/admin/upload`,{
    method:"POST",
    headers:{ "x-admin-key": getKey() },
    body:fd
  });

  if(!res.ok){
    alert("Image upload failed");
    return;
  }

  const data=await res.json();
  uploadedImages=data.images||[];

  uploadedImages.forEach(i=>{
    const img=document.createElement("img");
    img.src=i.url;
    img.className="miniimg";
    preview.appendChild(img);
  });
});

/* =====================================================
   ADD PRODUCT
===================================================== */
async function addProduct(){
  status.innerText="Saving...";

  const body={
    title:title.value.trim(),
    price:Number(price.value),
    category:category.value,
    stock:Number(stock.value),
    description:description.value.trim(),
    images:uploadedImages
  };

  const res=await fetch(`${API}/api/admin/products`,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "x-admin-key":getKey()
    },
    body:JSON.stringify(body)
  });

  status.innerText=res.ok?"Added ✅":"Error";
  if(res.ok){
    title.value="";
    price.value="";
    stock.value="";
    description.value="";
    imageUpload.value="";
    preview.innerHTML="";
    uploadedImages=[];
    loadProducts();
  }
}

/* =====================================================
   LOAD PRODUCTS
===================================================== */
async function loadProducts(){
  const res=await fetch(`${API}/api/admin/products`,{
    headers:{ "x-admin-key":getKey() }
  });

  const products=await res.json();
  productRows.innerHTML="";

  products.forEach(p=>{
    productRows.innerHTML+=`
      <tr>
        <td>${p.images?.[0]?`<img class="miniimg" src="${p.images[0].url}">`:"—"}</td>
        <td>${p.title}</td>
        <td>${p.category}</td>
        <td>₹${p.price}</td>
        <td>
          <button class="danger" onclick="deleteProduct('${p._id}')">Delete</button>
        </td>
      </tr>
    `;
  });
}

/* =====================================================
   DELETE PRODUCT
===================================================== */
async function deleteProduct(id){
  if(!confirm("Delete product?")) return;

  await fetch(`${API}/api/admin/products/${id}`,{
    method:"DELETE",
    headers:{ "x-admin-key":getKey() }
  });

  loadProducts();
}

/* =====================================================
   ANALYTICS
===================================================== */
async function loadAnalytics(){
  const res=await fetch(`${API}/api/admin/analytics?range=${range.value}`,{
    headers:{ "x-admin-key":getKey() }
  });

  const d=await res.json();
  statOrders.innerText=d.totalOrders||0;
  statRevenue.innerText=(d.totalRevenue||0).toLocaleString("en-IN");
  statTop.innerText=d.topProducts?.[0]?.title||"—";
}
</script>

</body>
</html>
